create table NH_SON_NHAXUATBAN(
    ID NUMBER(4) NOT NULL ,
    MA NUMBER(4),
    TEN NVARCHAR2(30),
    TRANG_THAI VARCHAR2(10),
    DIA_CHI NVARCHAR2(50),
    MO_TA NVARCHAR2(50),
    CONSTRAINT UNI_MA_NXB UNIQUE (MA),
    PRIMARY KEY (ID)
);
select*from NH_SON_NHAXUATBAN;

CREATE TABLE NH_SON_TACGIA(
    ID NUMBER(4) NOT NULL ,
    MA NUMBER(4),
    TEN NVARCHAR2(30),
    SDT INT,
    DIA_CHI NVARCHAR2(50),
    MOTA NVARCHAR2(50),
    CONSTRAINT UNI_MA_TACGIA UNIQUE (MA),
    PRIMARY KEY (ID)
);

SELECT *FROM NH_SON_TACGIA;
CREATE TABLE NH_SON_SACH(
    ID NUMBER(4) NOT NULL,
    MA NUMBER(4),
    TEN NVARCHAR2(30),
    ID_NXB NUMBER(4),
    ID_TACGIA NUMBER(4),
    CHU_DE NVARCHAR2(20),
    NAM_XUAT_BAN DATE,
    MOTA NVARCHAR2(50),
    SO_LUONG_CON_LAI NUMBER,
    SO_LUONG_DANG_MUON NUMBER,
    TONG_SO_SACH NUMBER,
    CONSTRAINT UNI_MA_SACH UNIQUE (MA),
    PRIMARY KEY (ID),
    FOREIGN KEY (ID_NXB) REFERENCES NH_SON_NHAXUATBAN(ID),
    FOREIGN KEY (ID_TACGIA) REFERENCES NH_SON_TACGIA(ID)
);

CREATE TABLE NH_SON_BANDOC(
    ID NUMBER(4) NOT NULL,
    MA NUMBER(4),
    TEN NVARCHAR2(30),
    SO_DIEN_THOAI NUMBER,
    DIA_CHI NVARCHAR2(50),
    NGAY_SINH DATE,
    NGAY_TAO_TAI_KHOAN DATE,
    HANG VARCHAR2(5),
    CONSTRAINT UNI_MA_BANDOC UNIQUE (MA),
    PRIMARY KEY (ID)
);

CREATE TABLE NH_SON_MUONSACH
(
    ID         NUMBER(4),
    ID_BAN_HOC NUMBER(4),
    ID_SACH    NUMBER(4),
    SO_LUONG    NUMBER,
    NGAY_GIO_MUON DATE,
    NGAY_GIO_TRA DATE,
    TRANG_THAI VARCHAR2(10),
    GHI_CHU NVARCHAR2(50),
    PRIMARY KEY (ID),
    FOREIGN KEY (ID_BAN_HOC) REFERENCES NH_SON_BANDOC(ID),
    FOREIGN KEY (ID_SACH) REFERENCES NH_SON_SACH(ID)
);

--1.
CREATE INDEX SONNH_BANDOC_INDEX_ID ON NH_SON_BANDOC(ID);


--2.	Viết script tạo sequence cho mỗi bảng. Sequence được dùng để insert trường Id cho các bảng. Tên sequence theo cấu trúc : TENBANG_SEQ
CREATE SEQUENCE NHAXUATBAN_SEQ_SONNH INCREMENT BY 1 START WITH 1 NOCYCLE;
CREATE SEQUENCE TACGIA_SEQ_SONNH INCREMENT BY 1 START WITH 1 NOCYCLE;
CREATE SEQUENCE SACH_SEQ_SONNH INCREMENT BY 1 START WITH 1 NOCYCLE;
CREATE SEQUENCE BANDOC_SEQ_SONNH INCREMENT BY 1 START WITH 1 NOCYCLE;
CREATE SEQUENCE MUONSACH_SEQ_SONNH INCREMENT BY 1 START WITH 1 NOCYCLE;
--4.	Viết script insert dữ liệu mẫu cho tất cả các bảng.
--NSB
INSERT INTO NH_SON_NHAXUATBAN VALUES (NHAXUATBAN_SEQ_SONNH.nextval,1,'NGUYEN HONG SON','ACTIVE','HAI DUONG','HAY');
INSERT INTO NH_SON_NHAXUATBAN VALUES (NHAXUATBAN_SEQ_SONNH.nextval,2,'NGUYEN THI HA','ACTIVE','HAI DUONG','HAY');
INSERT INTO NH_SON_NHAXUATBAN VALUES (NHAXUATBAN_SEQ_SONNH.nextval,3,'THIEU QUANG VINH','ACTIVE','THANH HOA','HAY');
INSERT INTO NH_SON_NHAXUATBAN VALUES (NHAXUATBAN_SEQ_SONNH.nextval,4,'DO TAT HOA','ACTIVE','THANH HOA','HAY');
--TG
INSERT INTO NH_SON_TACGIA VALUES (TACGIA_SEQ_SONNH.nextval,1,'TO HOAI','0325468695','HAI DUONG','VAN HAY');
INSERT INTO NH_SON_TACGIA VALUES (TACGIA_SEQ_SONNH.nextval,2,'NGUYEN DU','0356896589','HAI DUONG','VAN HAY');
INSERT INTO NH_SON_TACGIA VALUES (TACGIA_SEQ_SONNH.nextval,3,'HO CHI MINH','0213569875','THANH HOA','VAN HAY');
--SACH
INSERT INTO NH_SON_SACH VALUES (SACH_SEQ_SONNH.nextval,1,'CHI EM THUY KIEU',1,2,'KIEU','19-JAN-1992','HAY',10, 20,30);
INSERT INTO NH_SON_SACH VALUES (SACH_SEQ_SONNH.nextval,2,'DONG CHI',2,2,'DONG CHI','20-DEC-1975','HAY',5, 30,35);
INSERT INTO NH_SON_SACH VALUES (SACH_SEQ_SONNH.nextval,3,'SACH 3',4,2,'DONG CHI','20-DEC-1975','HAY',14, 3,17);
INSERT INTO NH_SON_SACH VALUES (SACH_SEQ_SONNH.nextval,4,'SACH 4',2,1,'DONG CHI','20-DEC-1975','HAY',9, 40,49);
INSERT INTO NH_SON_SACH VALUES (SACH_SEQ_SONNH.nextval,5,'SACH 5',4,3,'DONG CHI','20-DEC-1975','HAY',20, 10,30);
SELECT*FROM NH_SON_SACH
--BAN DOC
INSERT INTO NH_SON_BANDOC VALUES (BANDOC_SEQ_SONNH.nextval,1,'PHAM THI THUY',0236598648,'HAI DUONG','19-FEB-2002','10-DEC-2022','VANG');
INSERT INTO NH_SON_BANDOC VALUES (BANDOC_SEQ_SONNH.nextval,2,'PHAM THI NGA',0231928371,'HAI DUONG','01-FEB-2002','10-DEC-2022','BAC');
INSERT INTO NH_SON_BANDOC VALUES (BANDOC_SEQ_SONNH.nextval,3,'PHAM THU BAU',0236912371,'HAI DUONG','20-FEB-2002','10-DEC-2022','DONG');

--MUON SACH
INSERT INTO NH_SON_MUONSACH VALUES (MUONSACH_SEQ_SONNH.nextval,2,1,3,'22-JAN-2020','30-JAN-2020','DA TRA','TOT');
INSERT INTO NH_SON_MUONSACH VALUES (MUONSACH_SEQ_SONNH.nextval,3,2,1,'22-JAN-2020','30-JAN-2020','DANG MUON','TOT');
INSERT INTO NH_SON_MUONSACH VALUES (MUONSACH_SEQ_SONNH.nextval,1,2,1,'22-JAN-2020','30-JAN-2020','DA TRA','TOT');
SELECT*FROM NH_SON_MUONSACH


 -- 5.	Hiển thị dách sách tác giả và tổng số lượng sách của tác giả gồm các trường thông tin:
--     Mã Tác Giả, Tên Tác Giả, Chủ Đề, Số Lượng Sách
-- Sắp xếp theo số lượng sách giảm dần.
SELECT TG.MA, TG.TEN, S.CHU_DE,S.SO_LUONG_CON_LAI
FROM NH_SON_SACH S INNER JOIN NH_SON_TACGIA TG ON S.ID_TACGIA = TG.ID
ORDER BY SO_LUONG_CON_LAI DESC;
--6.	Hiển thị 10 quyển sách có số lượng được mượn nhiều nhất gồm các trường thông tin:
--    Mã Sách, Tên Sách, Tên Nhà Xuất Bản, Tên Tác Giả, Chủ Đề, Năm Xuất Bản, Số Lượng Còn Lại, Số Lượng Đã Mượn, Tổng Số
select S.MA, S.TEN, NXB.TEN,TG.TEN, S.CHU_DE, S.NAM_XUAT_BAN, MAX(S.SO_LUONG_DANG_MUON),S.TONG_SO_SACH
from NH_SON_SACH S INNER JOIN NH_SON_TACGIA TG ON S.ID_TACGIA = TG.ID
                        join NH_SON_NHAXUATBAN NXB on S.ID_NXB = NXB.ID
WHERE ROWNUM < 11
GROUP BY S.MA, S.TEN, NXB.TEN,TG.TEN, S.CHU_DE, S.NAM_XUAT_BAN,S.TONG_SO_SACH;

-- 7.	Hiển thị  thông tin bạn đọc và sách được mượn từ ngày đầu tháng hiện tại đến thời điểm hiện tại.
SELECT BD.MA, BD.TEN, S.MA,S.TEN, MIN(MS.NGAY_GIO_MUON) , MS.SO_LUONG
FROM NH_SON_BANDOC BD JOIN NH_SON_MUONSACH MS ON BD.ID = MS.ID_BAN_HOC
                                JOIN NH_SON_SACH S ON MS.ID_SACH = S.ID
WHERE MS.NGAY_GIO_MUON BETWEEN '01-AUG-2022' AND SYSDATE
GROUP BY BD.MA, BD.TEN, S.MA,S.TEN,MS.SO_LUONG
ORDER BY BD.TEN DESC;

--8.	Hiển thị 10 quyển sách có số lượng được mượn nhiều nhất tính từ đầu năm 2022
SELECT S.MA,S.TEN,MAX(SO_LUONG_DANG_MUON)
FROM NH_SON_SACH S JOIN NH_SON_MUONSACH MS ON S.ID = MS.ID_SACH
WHERE ROWNUM <11 AND TO_CHAR(NGAY_GIO_MUON ,'YYYY')='2022'
GROUP BY S.MA,S.TEN;
--9.	Hiển thị danh sách bạn đọc và số lần mượn sách tính từ đầu năm 2022 sắp xếp theo tên bạn đọc tăng dần:
SELECT BD.MA,BD.TEN,COUNT(ID_BAN_HOC)
    FROM NH_SON_BANDOC BD JOIN NH_SON_MUONSACH MS ON BD.ID = MS.ID_BAN_HOC
    WHERE TO_CHAR(NGAY_GIO_MUON,'YYYY') = '2022'
GROUP BY BD.MA,BD.TEN
ORDER BY BD.TEN ASC ;
--10.	Hiển thị thông tin bạn đọc gồm có:
-- Mã Bạn Đọc, Tên Bạn Đọc, Tuổi (được tính dựa vào trường ngày sinh)
SELECT MA,TEN,(TO_CHAR(SYSDATE,'YYYY') - TO_CHAR(NGAY_SINH,'YYYY')) TUOI FROM NH_SON_BANDOC;
--11.	Thống kê tổng số bạn đọc theo độ tuổi
SELECT (TO_CHAR(SYSDATE,'YYYY') - TO_CHAR(NGAY_SINH,'YYYY')) TUOI, COUNT(MA) FROM NH_SON_BANDOC
GROUP BY (TO_CHAR(SYSDATE,'YYYY') - TO_CHAR(NGAY_SINH,'YYYY'));
--12. Thống kê so lượng sách được xuất bản theo Nhà Xuất Bản, Theo năm xuất bản.
SELECT NXB.TEN, SUM(TONG_SO_SACH) AS TONG_SO_LUONG_SACH, TO_CHAR(NAM_XUAT_BAN, 'YYYY') AS NAMSX
FROM NH_SON_NHAXUATBAN NXB
         JOIN NH_SON_SACH VS on NXB.ID = VS.ID_NXB
group by NXB.TEN, TO_CHAR(NAM_XUAT_BAN, 'YYYY')
ORDER BY TO_CHAR(NAM_XUAT_BAN, 'YYYY') DESC;